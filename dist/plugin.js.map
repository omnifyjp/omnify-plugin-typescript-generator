{"version":3,"sources":["../src/plugin.ts"],"sourcesContent":["/**\n * @famgia/omnify-typescript - Plugin\n *\n * Plugin for generating TypeScript type definitions and Zod schemas from Omnify schemas.\n *\n * ## Usage\n *\n * ```typescript\n * import { defineConfig } from '@famgia/omnify';\n * import typescript from '@famgia/omnify-typescript/plugin';\n *\n * export default defineConfig({\n *   plugins: [\n *     typescript({\n *       modelsPath: 'resources/ts/omnify',\n *       generateZodSchemas: true,\n *     }),\n *   ],\n * });\n * ```\n *\n * ## With @famgia/omnify-react\n *\n * Use with `@famgia/omnify-react` runtime package for React utilities:\n *\n * ```typescript\n * import {\n *   JapaneseNameField,\n *   JapaneseAddressField,\n *   useFormMutation,\n *   zodRule,\n * } from '@famgia/omnify-react';\n * ```\n */\n\nimport type { OmnifyPlugin, GeneratorOutput, GeneratorContext, PluginConfigSchema } from '@famgia/omnify-types';\nimport { generateTypeScript } from './generator.js';\nimport path from 'path';\n\n/**\n * Default paths\n */\nconst DEFAULTS = {\n  modelsPath: 'resources/ts/omnify',\n};\n\n/**\n * Configuration schema for TypeScript plugin UI settings\n */\nconst TYPESCRIPT_CONFIG_SCHEMA: PluginConfigSchema = {\n  fields: [\n    {\n      key: 'modelsPath',\n      type: 'path',\n      label: 'Schemas Output Path',\n      description: 'Directory for generated TypeScript types and Zod schemas.',\n      default: DEFAULTS.modelsPath,\n      group: 'output',\n    },\n    {\n      key: 'generateZodSchemas',\n      type: 'boolean',\n      label: 'Generate Zod Schemas',\n      description: 'Generate Zod schemas alongside TypeScript types for form validation',\n      default: true,\n      group: 'output',\n    },\n  ],\n};\n\n/**\n * Options for the TypeScript plugin.\n */\nexport interface TypeScriptPluginOptions {\n  /**\n   * Path for TypeScript model files.\n   *\n   * @default 'resources/ts/omnify'\n   */\n  modelsPath?: string;\n  /**\n   * Generate Zod schemas alongside TypeScript types.\n   * @default true\n   */\n  generateZodSchemas?: boolean;\n}\n\n/**\n * Resolved options with defaults applied.\n */\ninterface ResolvedOptions {\n  modelsPath: string;\n  generateZodSchemas: boolean;\n}\n\n/**\n * Resolves options with defaults.\n */\nfunction resolveOptions(options?: TypeScriptPluginOptions): ResolvedOptions {\n  return {\n    modelsPath: options?.modelsPath ?? DEFAULTS.modelsPath,\n    generateZodSchemas: options?.generateZodSchemas ?? true,\n  };\n}\n\n/**\n * Creates the TypeScript plugin with the specified options.\n *\n * @param options - Plugin configuration options\n * @returns OmnifyPlugin configured for TypeScript generation\n */\nexport default function typescriptPlugin(options?: TypeScriptPluginOptions): OmnifyPlugin {\n  const resolved = resolveOptions(options);\n\n  return {\n    name: '@famgia/omnify-typescript',\n    version: '0.0.1',\n    configSchema: TYPESCRIPT_CONFIG_SCHEMA,\n\n    generators: [\n      {\n        name: 'typescript-models',\n        description: 'Generate TypeScript model definitions',\n\n        generate: async (ctx: GeneratorContext): Promise<GeneratorOutput[]> => {\n          // Determine plugin enum path - relative to the schemas folder's node_modules\n          // e.g., if modelsPath is \"./frontend/src/omnify/schemas\", \n          // plugin enums go to \"./frontend/node_modules/@omnify-client/enum\"\n          const modelsDir = path.dirname(resolved.modelsPath);\n          const frontendRoot = modelsDir.replace(/\\/src\\/.*$/, '');\n          const pluginEnumBase = `${frontendRoot}/node_modules/@omnify-client`;\n          const pluginEnumPath = `${pluginEnumBase}/enum`;\n          const hasPluginEnums = ctx.pluginEnums && ctx.pluginEnums.size > 0;\n\n          const files = generateTypeScript(ctx.schemas, {\n            generateZodSchemas: resolved.generateZodSchemas,\n            localeConfig: ctx.localeConfig,\n            customTypes: ctx.customTypes,\n            pluginEnums: ctx.pluginEnums,\n            pluginEnumImportPrefix: '@omnify-client/enum',\n          });\n\n          const outputs: GeneratorOutput[] = [];\n\n          // Add package.json for @omnify-client if plugin enums exist\n          if (hasPluginEnums) {\n            outputs.push({\n              path: `${pluginEnumBase}/package.json`,\n              content: JSON.stringify({\n                name: '@omnify-client',\n                version: '0.0.0',\n                private: true,\n                main: './enum/index.js',\n                exports: {\n                  './enum/*': './enum/*.js',\n                },\n              }, null, 2),\n              type: 'other' as const,\n              skipIfExists: false,\n            });\n          }\n\n          for (const file of files) {\n            // Determine output path based on category\n            let outputPath: string;\n            if (file.category === 'plugin-enum') {\n              // Plugin enums go to frontend/node_modules/@omnify-client/enum/\n              outputPath = `${pluginEnumPath}/${file.filePath}`;\n            } else if (file.category === 'enum') {\n              // Schema enums go to ../enum/ folder (sibling to schemas)\n              const enumPath = resolved.modelsPath.replace(/\\/schemas\\/?$/, '/enum');\n              outputPath = `${enumPath}/${file.filePath}`;\n            } else {\n              outputPath = `${resolved.modelsPath}/${file.filePath}`;\n            }\n\n            outputs.push({\n              path: outputPath,\n              content: file.content,\n              type: 'type' as const,\n              skipIfExists: !file.overwrite, // Invert: overwrite=true means skipIfExists=false\n              metadata: {\n                types: file.types,\n              },\n            });\n          }\n\n          return outputs;\n        },\n      },\n    ],\n  };\n}\n\n// Named export for flexibility\nexport { typescriptPlugin };\n\n// Export defaults for user convenience\nexport { DEFAULTS };\n\n// Legacy exports for backwards compatibility\nexport const MODERN_DEFAULTS = DEFAULTS;\nexport const LEGACY_DEFAULTS = DEFAULTS;\n\n/**\n * Create TypeScript plugin with default settings.\n *\n * @example\n * ```typescript\n * import { typescriptModern } from '@famgia/omnify-typescript/plugin';\n *\n * export default defineConfig({\n *   plugins: [typescriptModern()],\n * });\n * ```\n */\nexport function typescriptModern(options?: TypeScriptPluginOptions): OmnifyPlugin {\n  return typescriptPlugin({\n    ...options,\n    modelsPath: options?.modelsPath ?? DEFAULTS.modelsPath,\n  });\n}\n"],"mappings":";;;;;AAqCA,OAAO,UAAU;AAKjB,IAAM,WAAW;AAAA,EACf,YAAY;AACd;AAKA,IAAM,2BAA+C;AAAA,EACnD,QAAQ;AAAA,IACN;AAAA,MACE,KAAK;AAAA,MACL,MAAM;AAAA,MACN,OAAO;AAAA,MACP,aAAa;AAAA,MACb,SAAS,SAAS;AAAA,MAClB,OAAO;AAAA,IACT;AAAA,IACA;AAAA,MACE,KAAK;AAAA,MACL,MAAM;AAAA,MACN,OAAO;AAAA,MACP,aAAa;AAAA,MACb,SAAS;AAAA,MACT,OAAO;AAAA,IACT;AAAA,EACF;AACF;AA8BA,SAAS,eAAe,SAAoD;AAC1E,SAAO;AAAA,IACL,YAAY,SAAS,cAAc,SAAS;AAAA,IAC5C,oBAAoB,SAAS,sBAAsB;AAAA,EACrD;AACF;AAQe,SAAR,iBAAkC,SAAiD;AACxF,QAAM,WAAW,eAAe,OAAO;AAEvC,SAAO;AAAA,IACL,MAAM;AAAA,IACN,SAAS;AAAA,IACT,cAAc;AAAA,IAEd,YAAY;AAAA,MACV;AAAA,QACE,MAAM;AAAA,QACN,aAAa;AAAA,QAEb,UAAU,OAAO,QAAsD;AAIrE,gBAAM,YAAY,KAAK,QAAQ,SAAS,UAAU;AAClD,gBAAM,eAAe,UAAU,QAAQ,cAAc,EAAE;AACvD,gBAAM,iBAAiB,GAAG,YAAY;AACtC,gBAAM,iBAAiB,GAAG,cAAc;AACxC,gBAAM,iBAAiB,IAAI,eAAe,IAAI,YAAY,OAAO;AAEjE,gBAAM,QAAQ,mBAAmB,IAAI,SAAS;AAAA,YAC5C,oBAAoB,SAAS;AAAA,YAC7B,cAAc,IAAI;AAAA,YAClB,aAAa,IAAI;AAAA,YACjB,aAAa,IAAI;AAAA,YACjB,wBAAwB;AAAA,UAC1B,CAAC;AAED,gBAAM,UAA6B,CAAC;AAGpC,cAAI,gBAAgB;AAClB,oBAAQ,KAAK;AAAA,cACX,MAAM,GAAG,cAAc;AAAA,cACvB,SAAS,KAAK,UAAU;AAAA,gBACtB,MAAM;AAAA,gBACN,SAAS;AAAA,gBACT,SAAS;AAAA,gBACT,MAAM;AAAA,gBACN,SAAS;AAAA,kBACP,YAAY;AAAA,gBACd;AAAA,cACF,GAAG,MAAM,CAAC;AAAA,cACV,MAAM;AAAA,cACN,cAAc;AAAA,YAChB,CAAC;AAAA,UACH;AAEA,qBAAW,QAAQ,OAAO;AAExB,gBAAI;AACJ,gBAAI,KAAK,aAAa,eAAe;AAEnC,2BAAa,GAAG,cAAc,IAAI,KAAK,QAAQ;AAAA,YACjD,WAAW,KAAK,aAAa,QAAQ;AAEnC,oBAAM,WAAW,SAAS,WAAW,QAAQ,iBAAiB,OAAO;AACrE,2BAAa,GAAG,QAAQ,IAAI,KAAK,QAAQ;AAAA,YAC3C,OAAO;AACL,2BAAa,GAAG,SAAS,UAAU,IAAI,KAAK,QAAQ;AAAA,YACtD;AAEA,oBAAQ,KAAK;AAAA,cACX,MAAM;AAAA,cACN,SAAS,KAAK;AAAA,cACd,MAAM;AAAA,cACN,cAAc,CAAC,KAAK;AAAA;AAAA,cACpB,UAAU;AAAA,gBACR,OAAO,KAAK;AAAA,cACd;AAAA,YACF,CAAC;AAAA,UACH;AAEA,iBAAO;AAAA,QACT;AAAA,MACF;AAAA,IACF;AAAA,EACF;AACF;AASO,IAAM,kBAAkB;AACxB,IAAM,kBAAkB;AAcxB,SAAS,iBAAiB,SAAiD;AAChF,SAAO,iBAAiB;AAAA,IACtB,GAAG;AAAA,IACH,YAAY,SAAS,cAAc,SAAS;AAAA,EAC9C,CAAC;AACH;","names":[]}