{"version":3,"sources":["../src/plugin.ts"],"sourcesContent":["/**\n * @famgia/omnify-typescript - Plugin\n *\n * Plugin for generating TypeScript type definitions and Zod schemas from Omnify schemas.\n *\n * ## Modern Mode (Recommended)\n *\n * Use with `@famgia/omnify-react` runtime package:\n * - Output to `node_modules/.omnify/` (like Prisma's .prisma/)\n * - Schemas are re-exported from `@famgia/omnify-react`\n * - No stubs generated (use package's components/hooks)\n *\n * ```typescript\n * typescript({\n *   modelsPath: 'node_modules/.omnify/schemas',\n *   stubsPath: false, // Use @famgia/omnify-react instead\n * })\n * ```\n *\n * ## Legacy Mode\n *\n * For projects not using `@famgia/omnify-react`:\n * - Output to custom path (e.g., 'resources/ts/omnify/schemas')\n * - Stubs generated alongside schemas\n *\n * ```typescript\n * typescript({\n *   modelsPath: 'resources/ts/omnify/schemas',\n *   stubsPath: 'resources/ts/omnify', // Generate stubs\n * })\n * ```\n *\n * @example\n * ```typescript\n * import { defineConfig } from '@famgia/omnify';\n * import typescript from '@famgia/omnify-typescript/plugin';\n *\n * export default defineConfig({\n *   plugins: [\n *     typescript({\n *       modelsPath: 'node_modules/.omnify/schemas', // Modern (Prisma-like)\n *       generateZodSchemas: true,\n *     }),\n *   ],\n * });\n * ```\n */\n\nimport type { OmnifyPlugin, GeneratorOutput, GeneratorContext, PluginConfigSchema } from '@famgia/omnify-types';\nimport { generateTypeScript } from './generator.js';\nimport fs from 'fs';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n\n/**\n * Default paths for modern mode (node_modules/.omnify/)\n */\nconst MODERN_DEFAULTS = {\n  modelsPath: 'node_modules/.omnify/schemas',\n  stubsPath: false as const,\n};\n\n/**\n * Default paths for legacy mode (types/schemas)\n */\nconst LEGACY_DEFAULTS = {\n  modelsPath: 'types/schemas',\n  stubsPath: 'omnify',\n};\n\n/**\n * Configuration schema for TypeScript plugin UI settings\n */\nconst TYPESCRIPT_CONFIG_SCHEMA: PluginConfigSchema = {\n  fields: [\n    {\n      key: 'modelsPath',\n      type: 'path',\n      label: 'Schemas Output Path',\n      description: 'Directory for generated TypeScript types and Zod schemas. Use \"node_modules/.omnify/schemas\" for modern mode with @famgia/omnify-react.',\n      default: LEGACY_DEFAULTS.modelsPath,\n      group: 'output',\n    },\n    {\n      key: 'generateZodSchemas',\n      type: 'boolean',\n      label: 'Generate Zod Schemas',\n      description: 'Generate Zod schemas alongside TypeScript types for form validation',\n      default: true,\n      group: 'output',\n    },\n    {\n      key: 'stubsPath',\n      type: 'path',\n      label: 'React Stubs Path',\n      description: 'Directory for React utility stubs (hooks, components). Leave empty to disable. Recommended: use @famgia/omnify-react instead.',\n      default: LEGACY_DEFAULTS.stubsPath,\n      group: 'output',\n    },\n  ],\n};\n\n/**\n * Options for the TypeScript plugin.\n */\nexport interface TypeScriptPluginOptions {\n  /**\n   * Path for TypeScript model files.\n   *\n   * Modern mode: 'node_modules/.omnify/schemas' (use with @famgia/omnify-react)\n   * Legacy mode: 'types/schemas' or custom path\n   *\n   * @default 'types/schemas'\n   */\n  modelsPath?: string;\n  /**\n   * Generate Zod schemas alongside TypeScript types.\n   * @default true\n   */\n  generateZodSchemas?: boolean;\n  /**\n   * Path for React utility stubs (hooks, components, lib).\n   * Set to false to disable stub generation.\n   *\n   * When using @famgia/omnify-react, set to false.\n   *\n   * @default 'omnify'\n   */\n  stubsPath?: string | false;\n}\n\n/**\n * Resolved options with defaults applied.\n */\ninterface ResolvedOptions {\n  modelsPath: string;\n  generateZodSchemas: boolean;\n  stubsPath: string | false;\n  isModernMode: boolean;\n}\n\n/**\n * Check if the path targets node_modules (modern mode)\n */\nfunction isNodeModulesPath(p: string): boolean {\n  return p.includes('node_modules');\n}\n\n/**\n * Resolves options with defaults.\n */\nfunction resolveOptions(options?: TypeScriptPluginOptions): ResolvedOptions {\n  const modelsPath = options?.modelsPath ?? LEGACY_DEFAULTS.modelsPath;\n  const isModernMode = isNodeModulesPath(modelsPath);\n\n  // In modern mode, disable stubs by default (use @famgia/omnify-react)\n  const defaultStubsPath = isModernMode ? false : LEGACY_DEFAULTS.stubsPath;\n\n  return {\n    modelsPath,\n    generateZodSchemas: options?.generateZodSchemas ?? true,\n    stubsPath: options?.stubsPath ?? defaultStubsPath,\n    isModernMode,\n  };\n}\n\n/**\n * Stub file definitions for React utilities.\n */\nconst STUB_FILES = [\n  // Components\n  {\n    stub: 'JapaneseNameField.tsx.stub',\n    output: 'components/JapaneseNameField.tsx',\n  },\n  {\n    stub: 'JapaneseAddressField.tsx.stub',\n    output: 'components/JapaneseAddressField.tsx',\n  },\n  {\n    stub: 'JapaneseBankField.tsx.stub',\n    output: 'components/JapaneseBankField.tsx',\n  },\n  // Hooks\n  {\n    stub: 'use-form-mutation.ts.stub',\n    output: 'hooks/use-form-mutation.ts',\n  },\n  // Lib - validation utilities\n  {\n    stub: 'zod-i18n.ts.stub',\n    output: 'lib/zod-i18n.ts',\n  },\n  {\n    stub: 'form-validation.ts.stub',\n    output: 'lib/form-validation.ts',\n  },\n  // Rules - Japanese validation rules\n  {\n    stub: 'rules/kana.ts.stub',\n    output: 'lib/rules/kana.ts',\n  },\n  {\n    stub: 'rules/index.ts.stub',\n    output: 'lib/rules/index.ts',\n  },\n];\n\n/**\n * Creates the TypeScript plugin with the specified options.\n *\n * @param options - Plugin configuration options\n * @returns OmnifyPlugin configured for TypeScript generation\n */\nexport default function typescriptPlugin(options?: TypeScriptPluginOptions): OmnifyPlugin {\n  const resolved = resolveOptions(options);\n\n  return {\n    name: '@famgia/omnify-typescript',\n    version: '0.0.1',\n    configSchema: TYPESCRIPT_CONFIG_SCHEMA,\n\n    generators: [\n      {\n        name: 'typescript-models',\n        description: 'Generate TypeScript model definitions',\n\n        generate: async (ctx: GeneratorContext): Promise<GeneratorOutput[]> => {\n          // Determine plugin enum path - relative to the schemas folder's node_modules\n          // e.g., if modelsPath is \"./frontend/src/omnify/schemas\", \n          // plugin enums go to \"./frontend/node_modules/@omnify-client/enum\"\n          const modelsDir = path.dirname(resolved.modelsPath);\n          const frontendRoot = modelsDir.replace(/\\/src\\/.*$/, '');\n          const pluginEnumBase = `${frontendRoot}/node_modules/@omnify-client`;\n          const pluginEnumPath = `${pluginEnumBase}/enum`;\n          const hasPluginEnums = ctx.pluginEnums && ctx.pluginEnums.size > 0;\n\n          const files = generateTypeScript(ctx.schemas, {\n            generateZodSchemas: resolved.generateZodSchemas,\n            localeConfig: ctx.localeConfig,\n            customTypes: ctx.customTypes,\n            pluginEnums: ctx.pluginEnums,\n            pluginEnumImportPrefix: '@omnify-client/enum',\n          });\n\n          const outputs: GeneratorOutput[] = [];\n\n          // Add package.json for @omnify-client if plugin enums exist\n          if (hasPluginEnums) {\n            outputs.push({\n              path: `${pluginEnumBase}/package.json`,\n              content: JSON.stringify({\n                name: '@omnify-client',\n                version: '0.0.0',\n                private: true,\n                main: './enum/index.js',\n                exports: {\n                  './enum/*': './enum/*.js',\n                },\n              }, null, 2),\n              type: 'other' as const,\n              skipIfExists: false,\n            });\n          }\n\n          for (const file of files) {\n            // Determine output path based on category\n            let outputPath: string;\n            if (file.category === 'plugin-enum') {\n              // Plugin enums go to frontend/node_modules/@omnify-client/enum/\n              outputPath = `${pluginEnumPath}/${file.filePath}`;\n            } else if (file.category === 'enum') {\n              // Schema enums go to ../enum/ folder (sibling to schemas)\n              const enumPath = resolved.modelsPath.replace(/\\/schemas\\/?$/, '/enum');\n              outputPath = `${enumPath}/${file.filePath}`;\n            } else {\n              outputPath = `${resolved.modelsPath}/${file.filePath}`;\n            }\n\n            outputs.push({\n              path: outputPath,\n              content: file.content,\n              type: 'type' as const,\n              skipIfExists: !file.overwrite, // Invert: overwrite=true means skipIfExists=false\n              metadata: {\n                types: file.types,\n              },\n            });\n          }\n\n          return outputs;\n        },\n      },\n      {\n        name: 'typescript-stubs',\n        description: 'Generate React utility stubs (hooks, components) - DEPRECATED: use @famgia/omnify-react',\n\n        generate: async (ctx: GeneratorContext): Promise<GeneratorOutput[]> => {\n          // Skip if stubs disabled\n          if (resolved.stubsPath === false) {\n            return [];\n          }\n\n          // Show deprecation warning when generating stubs\n          if (ctx.logger) {\n            ctx.logger.warn(\n              'Stub generation is deprecated. Consider using @famgia/omnify-react package instead.\\n' +\n              '  npm install @famgia/omnify-react\\n' +\n              '  Then set stubsPath: false in your config.'\n            );\n          }\n\n          const outputs: GeneratorOutput[] = [];\n          const stubsDir = path.join(__dirname, '..', 'stubs');\n\n          for (const { stub, output } of STUB_FILES) {\n            const stubPath = path.join(stubsDir, stub);\n            if (fs.existsSync(stubPath)) {\n              const content = fs.readFileSync(stubPath, 'utf-8');\n              outputs.push({\n                path: `${resolved.stubsPath}/${output}`,\n                content,\n                type: 'other' as const,\n                skipIfExists: false, // Always overwrite - library files should stay in sync\n              });\n            }\n          }\n\n          // Generate index files\n          outputs.push({\n            path: `${resolved.stubsPath}/components/index.ts`,\n            content: `export { JapaneseNameField, type JapaneseNameFieldProps } from './JapaneseNameField';\nexport { JapaneseAddressField, type JapaneseAddressFieldProps } from './JapaneseAddressField';\nexport { JapaneseBankField, type JapaneseBankFieldProps } from './JapaneseBankField';\n`,\n            type: 'other' as const,\n            skipIfExists: false,\n          });\n\n          outputs.push({\n            path: `${resolved.stubsPath}/hooks/index.ts`,\n            content: `export { useFormMutation } from './use-form-mutation';\n`,\n            type: 'other' as const,\n            skipIfExists: false,\n          });\n\n          outputs.push({\n            path: `${resolved.stubsPath}/lib/index.ts`,\n            content: `export { setZodLocale, getZodLocale, getZodMessage } from './zod-i18n';\nexport { zodRule, requiredRule } from './form-validation';\nexport * from './rules';\n`,\n            type: 'other' as const,\n            skipIfExists: false,\n          });\n\n          return outputs;\n        },\n      },\n    ],\n  };\n}\n\n// Named export for flexibility\nexport { typescriptPlugin };\n\n// Export defaults for user convenience\nexport { MODERN_DEFAULTS, LEGACY_DEFAULTS };\n\n/**\n * Create TypeScript plugin with modern mode defaults.\n * Use this when using @famgia/omnify-react package.\n *\n * @example\n * ```typescript\n * import { typescriptModern } from '@famgia/omnify-typescript/plugin';\n *\n * export default defineConfig({\n *   plugins: [typescriptModern()],\n * });\n * ```\n */\nexport function typescriptModern(options?: Omit<TypeScriptPluginOptions, 'modelsPath' | 'stubsPath'>): OmnifyPlugin {\n  return typescriptPlugin({\n    ...options,\n    modelsPath: MODERN_DEFAULTS.modelsPath,\n    stubsPath: MODERN_DEFAULTS.stubsPath,\n  });\n}\n"],"mappings":"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","names":[]}