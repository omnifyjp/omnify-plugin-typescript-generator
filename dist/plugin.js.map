{"version":3,"sources":["../src/plugin.ts"],"sourcesContent":["/**\n * @famgia/omnify-typescript - Plugin\n *\n * Plugin for generating TypeScript type definitions and Zod schemas from Omnify schemas.\n *\n * ## Usage\n *\n * ```typescript\n * import { defineConfig } from '@famgia/omnify';\n * import typescript from '@famgia/omnify-typescript/plugin';\n *\n * export default defineConfig({\n *   plugins: [\n *     typescript({\n *       modelsPath: 'resources/ts/omnify',\n *       generateZodSchemas: true,\n *     }),\n *   ],\n * });\n * ```\n *\n * ## With @famgia/omnify-react\n *\n * Use with `@famgia/omnify-react` runtime package for React utilities:\n *\n * ```typescript\n * import {\n *   JapaneseNameField,\n *   JapaneseAddressField,\n *   useFormMutation,\n *   zodRule,\n * } from '@famgia/omnify-react';\n * ```\n */\n\nimport type { OmnifyPlugin, GeneratorOutput, GeneratorContext, PluginConfigSchema } from '@famgia/omnify-types';\nimport { generateTypeScript } from './generator.js';\nimport path from 'path';\n\n/**\n * Default paths\n */\nconst DEFAULTS = {\n  modelsPath: 'resources/ts/omnify',\n};\n\n/**\n * Configuration schema for TypeScript plugin UI settings\n */\nconst TYPESCRIPT_CONFIG_SCHEMA: PluginConfigSchema = {\n  fields: [\n    {\n      key: 'modelsPath',\n      type: 'path',\n      label: 'Schemas Output Path',\n      description: 'Directory for generated TypeScript types and Zod schemas.',\n      default: DEFAULTS.modelsPath,\n      group: 'output',\n    },\n    {\n      key: 'generateZodSchemas',\n      type: 'boolean',\n      label: 'Generate Zod Schemas',\n      description: 'Generate Zod schemas alongside TypeScript types for form validation',\n      default: true,\n      group: 'output',\n    },\n  ],\n};\n\n/**\n * Options for the TypeScript plugin.\n */\nexport interface TypeScriptPluginOptions {\n  /**\n   * Path for TypeScript model files.\n   *\n   * @default 'resources/ts/omnify'\n   */\n  modelsPath?: string;\n  /**\n   * Generate Zod schemas alongside TypeScript types.\n   * @default true\n   */\n  generateZodSchemas?: boolean;\n}\n\n/**\n * Resolved options with defaults applied.\n */\ninterface ResolvedOptions {\n  modelsPath: string;\n  generateZodSchemas: boolean;\n}\n\n/**\n * Resolves options with defaults.\n */\nfunction resolveOptions(options?: TypeScriptPluginOptions): ResolvedOptions {\n  return {\n    modelsPath: options?.modelsPath ?? DEFAULTS.modelsPath,\n    generateZodSchemas: options?.generateZodSchemas ?? true,\n  };\n}\n\n/**\n * Creates the TypeScript plugin with the specified options.\n *\n * @param options - Plugin configuration options\n * @returns OmnifyPlugin configured for TypeScript generation\n */\nexport default function typescriptPlugin(options?: TypeScriptPluginOptions): OmnifyPlugin {\n  const resolved = resolveOptions(options);\n\n  return {\n    name: '@famgia/omnify-typescript',\n    version: '0.0.1',\n    configSchema: TYPESCRIPT_CONFIG_SCHEMA,\n\n    generators: [\n      {\n        name: 'typescript-models',\n        description: 'Generate TypeScript model definitions',\n\n        generate: async (ctx: GeneratorContext): Promise<GeneratorOutput[]> => {\n          // @omnify-base goes to node_modules/@omnify-base in the project root\n          // (where omnify.config.ts is located, same level as package.json)\n          const omnifyBaseDir = 'node_modules/@omnify-base';\n\n          const files = generateTypeScript(ctx.schemas, {\n            generateZodSchemas: resolved.generateZodSchemas,\n            localeConfig: ctx.localeConfig,\n            customTypes: ctx.customTypes,\n            pluginEnums: ctx.pluginEnums,\n            // All generated files (enums, base) go to @omnify-base - they shouldn't be edited\n            enumImportPrefix: '@omnify-base/enum',\n            pluginEnumImportPrefix: '@omnify-base/enum',\n            baseImportPrefix: '@omnify-base/schemas',\n          });\n\n          const outputs: GeneratorOutput[] = [];\n\n          // Check if we have any files that need @omnify-base package\n          const hasOmnifyClientFiles = files.some(f =>\n            f.category === 'enum' || f.category === 'plugin-enum' || f.category === 'base'\n          );\n\n          // Add package.json for @omnify-base\n          if (hasOmnifyClientFiles) {\n            outputs.push({\n              path: `${omnifyBaseDir}/package.json`,\n              content: JSON.stringify({\n                name: '@omnify-base',\n                version: '0.0.0',\n                private: true,\n                type: 'module',\n                exports: {\n                  // Wildcard exports for TypeScript bundlers (Vite, esbuild, etc.)\n                  './enum/*': {\n                    types: './enum/*.ts',\n                    default: './enum/*.ts',\n                  },\n                  './schemas/*': {\n                    types: './schemas/*.ts',\n                    default: './schemas/*.ts',\n                  },\n                },\n              }, null, 2),\n              type: 'other' as const,\n              skipIfExists: false,\n            });\n          }\n\n          for (const file of files) {\n            // Route files based on category:\n            // - overwrite: true files go to @omnify-base (shouldn't be edited)\n            // - overwrite: false files stay in modelsPath (user can edit)\n            let outputPath: string;\n\n            if (file.category === 'plugin-enum' || file.category === 'enum') {\n              // Enums → @omnify-base/enum/\n              outputPath = `${omnifyBaseDir}/enum/${file.filePath}`;\n            } else if (file.category === 'base') {\n              // Base files → @omnify-base/schemas/\n              // Remove 'base/' prefix from filePath (e.g., 'base/User.ts' → 'User.ts')\n              const fileName = file.filePath.replace(/^base\\//, '');\n              outputPath = `${omnifyBaseDir}/schemas/${fileName}`;\n            } else if (file.overwrite && (file.filePath === 'common.ts' || file.filePath === 'i18n.ts')) {\n              // Shared types and i18n → @omnify-base/schemas/\n              // These are imported via @omnify-base/schemas/common and @omnify-base/schemas/i18n\n              outputPath = `${omnifyBaseDir}/schemas/${file.filePath}`;\n            } else {\n              // User-editable files (models, index) → modelsPath\n              outputPath = `${resolved.modelsPath}/${file.filePath}`;\n            }\n\n            outputs.push({\n              path: outputPath,\n              content: file.content,\n              type: 'type' as const,\n              skipIfExists: !file.overwrite, // Invert: overwrite=true means skipIfExists=false\n              metadata: {\n                types: file.types,\n              },\n            });\n          }\n\n          return outputs;\n        },\n      },\n    ],\n  };\n}\n\n// Named export for flexibility\nexport { typescriptPlugin };\n\n// Export defaults for user convenience\nexport { DEFAULTS };\n\n// Legacy exports for backwards compatibility\nexport const MODERN_DEFAULTS = DEFAULTS;\nexport const LEGACY_DEFAULTS = DEFAULTS;\n\n/**\n * Create TypeScript plugin with default settings.\n *\n * @example\n * ```typescript\n * import { typescriptModern } from '@famgia/omnify-typescript/plugin';\n *\n * export default defineConfig({\n *   plugins: [typescriptModern()],\n * });\n * ```\n */\nexport function typescriptModern(options?: TypeScriptPluginOptions): OmnifyPlugin {\n  return typescriptPlugin({\n    ...options,\n    modelsPath: options?.modelsPath ?? DEFAULTS.modelsPath,\n  });\n}\n"],"mappings":"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","names":[]}