---
description: "Omnify schema YAML syntax and examples. Apply when creating or editing schema files in schemas/ folder. Covers property types, relationships, validations, and Japanese compound types."
globs: ["schemas/**/*.yaml", "schemas/**/*.yml", "{{LARAVEL_BASE}}/database/migrations/**"]
alwaysApply: false
---

# Omnify Schema Creation Workflow

> **Usage:** This rule auto-applies when editing schema files, or mention `@omnify-schema` in chat

## ğŸ“‹ Workflow Steps

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. READ GUIDE     â†’  Read schema guide documentation           â”‚
â”‚  2. CREATE SCHEMA  â†’  Create/modify YAML schema file            â”‚
â”‚  3. GENERATE       â†’  Run `npx omnify generate`                 â”‚
â”‚  4. VALIDATE       â†’  Check generated code matches requirements â”‚
â”‚  5. MIGRATE        â†’  Run database migration                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Step 1: Read Schema Guide ğŸ“–

**MUST READ before creating schema:**

```bash
# Read the schema guide
cat .claude/omnify/guides/omnify/schema-guide.md
# OR
cat packages/omnify/ai-guides/schema-guide.md
```

**Key Documentation:**
- Schema syntax and property types
- Relationships (belongsTo, hasMany, etc.)
- Validation rules (nullable, minLength, maxLength)
- Display names (ja, en, vi)
- Special types (JapaneseName, JapaneseAddress, etc.)

---

## Step 2: Create Schema ğŸ“

### Schema File Location

```
schemas/
â”œâ”€â”€ {domain}/           # Group by domain
â”‚   â”œâ”€â”€ {Model}.yaml    # PascalCase filename
â”‚   â””â”€â”€ {Enum}.yaml     # Enum schemas
â””â”€â”€ shared/             # Shared enums/types
```

### Basic Schema Template

```yaml
# schemas/{domain}/{ModelName}.yaml
name: ModelName
kind: object

displayName:
  ja: ãƒ¢ãƒ‡ãƒ«å
  en: Model Name

options:
  timestamps: true      # created_at, updated_at
  softDelete: false     # deleted_at

properties:
  # Required field
  name:
    type: String
    length: 100
    displayName:
      ja: åå‰
      en: Name
    placeholder:
      ja: ä¾‹ï¼šç”°ä¸­å¤ªéƒ
      en: e.g. John Doe

  # Optional field
  description:
    type: Text
    nullable: true
    displayName:
      ja: èª¬æ˜
      en: Description

  # Enum field
  status:
    type: OrderStatus
    default: pending
    displayName:
      ja: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
      en: Status

  # Relationship
  category:
    type: Category
    relation: belongsTo
    nullable: true
```

### From SQL/Database Requirements

When creating schema from SQL or database design:

```yaml
# SQL: VARCHAR(255) NOT NULL
property_name:
  type: String
  length: 255

# SQL: VARCHAR(100) NULL
property_name:
  type: String
  length: 100
  nullable: true

# SQL: TEXT
property_name:
  type: Text

# SQL: INT / BIGINT
property_name:
  type: Int  # or BigInt

# SQL: DECIMAL(10,2)
property_name:
  type: Float

# SQL: BOOLEAN DEFAULT false
property_name:
  type: Boolean
  default: false

# SQL: DATE
property_name:
  type: Date

# SQL: DATETIME / TIMESTAMP
property_name:
  type: DateTime

# SQL: ENUM('draft', 'published', 'archived')
# â†’ Create separate enum schema
```

---

## Step 3: Generate Code ğŸ”§

```bash
# Generate all code from schemas
npx omnify generate
```

**What gets generated:**
- TypeScript types & Zod schemas
- Laravel migrations & models
- API resources & controllers
- Form requests & validation

---

## Step 4: Validate Generated Code âœ…

### âš ï¸ CRITICAL for SQL-based schemas

**If creating schema from SQL requirements, MUST verify:**

```bash
# 1. Check generated migration matches SQL design
cat database/migrations/*_create_{table_name}_table.php

# 2. Check TypeScript types match requirements
cat resources/ts/omnify/schemas/{ModelName}.ts

# 3. Check Laravel model relationships
cat app/Models/{ModelName}.php
```

### Validation Checklist

| Check | What to Verify |
|-------|----------------|
| âœ… Column names | snake_case in migration matches schema |
| âœ… Column types | VARCHAR, TEXT, INT match schema types |
| âœ… Nullable | NULL/NOT NULL matches `nullable: true/false` |
| âœ… Defaults | DEFAULT values match `default:` in schema |
| âœ… Foreign keys | Relationships generate correct FK |
| âœ… Indexes | Required indexes are present |

### If Generated Code is Wrong

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Generated code doesn't match SQL?      â”‚
â”‚                                         â”‚
â”‚  1. Fix the YAML schema                 â”‚
â”‚  2. Run `npx omnify generate` again     â”‚
â”‚  3. Verify generated code               â”‚
â”‚  4. Repeat until correct                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Common fixes:**

```yaml
# Problem: Column should be nullable
# Fix: Add nullable: true
property_name:
  type: String
  nullable: true  # â† Add this

# Problem: Wrong column length
# Fix: Adjust length
property_name:
  type: String
  length: 255  # â† Change this

# Problem: Missing default value
# Fix: Add default
status:
  type: OrderStatus
  default: pending  # â† Add this

# Problem: Wrong relationship type
# Fix: Change relation
category:
  type: Category
  relation: belongsTo  # belongsTo, hasMany, hasOne, belongsToMany
```

### âš ï¸ CRITICAL: DB Functions NOT Allowed in Default

```yaml
# âŒ WRONG - DB functions are NOT allowed
failed_at:
  type: Timestamp
  default: CURRENT_TIMESTAMP  # ERROR!

# âœ… CORRECT - Use useCurrent option
failed_at:
  type: Timestamp
  useCurrent: true            # Equivalent to CURRENT_TIMESTAMP

updated_at:
  type: Timestamp
  useCurrent: true
  useCurrentOnUpdate: true    # ON UPDATE CURRENT_TIMESTAMP
```

---

## Step 5: Run Migration ğŸ—„ï¸

```bash
# Run migration
php artisan migrate

# If migration fails, rollback and fix
php artisan migrate:rollback
# Fix schema, regenerate, try again
```

---

## ğŸ”„ Complete Workflow Example

```bash
# 1. Read guide
cat .claude/omnify/guides/omnify/schema-guide.md

# 2. Create schema file
# schemas/shop/Product.yaml

# 3. Generate code
npx omnify generate

# 4. Validate (especially for SQL-based requirements)
cat database/migrations/*_create_products_table.php
# If wrong: fix schema â†’ regenerate â†’ validate again

# 5. Run migration
php artisan migrate
```

---

## ğŸ“Œ Quick Reference

### Property Types

| Type | SQL | TypeScript |
|------|-----|------------|
| `String` | VARCHAR | `string` |
| `Text` | TEXT | `string` |
| `LongText` | LONGTEXT | `string` |
| `Int` | INT | `number` |
| `BigInt` | BIGINT | `number` |
| `Float` | DECIMAL | `number` |
| `Boolean` | BOOLEAN | `boolean` |
| `Date` | DATE | `string` |
| `DateTime` | DATETIME | `string` |
| `Email` | VARCHAR | `string` |
| `Url` | VARCHAR | `string` |
| `Json` | JSON | `Record<string, unknown>` |

### Japanese Compound Types

| Type | Fields Generated |
|------|------------------|
| `JapaneseName` | `{prefix}_lastname`, `{prefix}_firstname`, `{prefix}_kana_lastname`, `{prefix}_kana_firstname` |
| `JapaneseAddress` | `{prefix}_postal_code`, `{prefix}_prefecture`, `{prefix}_address1`, `{prefix}_address2`, `{prefix}_address3` |
| `JapaneseBankAccount` | `{prefix}_bank_code`, `{prefix}_bank_name`, `{prefix}_branch_code`, etc. |

### Relationship Types

| Relation | Description | Foreign Key |
|----------|-------------|-------------|
| `belongsTo` | N:1 | `{property}_id` on this table |
| `hasMany` | 1:N | `{this_model}_id` on related table |
| `hasOne` | 1:1 | `{this_model}_id` on related table |
| `belongsToMany` | N:N | Pivot table |

---

## âš ï¸ Common Mistakes

```yaml
# âŒ Wrong: camelCase property name (use camelCase, converts to snake_case)
firstName:  # âœ… Correct - will become first_name in DB

# âŒ Wrong: Missing displayName for non-English projects
name:
  type: String
  # Missing displayName!

# âœ… Correct: Always add displayName
name:
  type: String
  displayName:
    ja: åå‰
    en: Name

# âŒ Wrong: Hardcoded enum values in property
status:
  type: String
  enum: [draft, published]  # Don't do this

# âœ… Correct: Create separate enum schema
status:
  type: PostStatus  # Reference enum schema
```
